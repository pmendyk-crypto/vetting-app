<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notify Radiologist ‚Äî Vetting Suite</title>
  <link rel="stylesheet" href="/static/css/site.css">
  <style>
    :root {
      --bg:        var(--bg-1);
      --surface:   var(--card-bg);
      --surface2:  rgba(0,0,0,0.2);
      --border:    var(--card-border);
      --accent:    var(--accent);
      --accent2:   #8b5cf6;
      --green:     #3fb950;
      --red:       #f85149;
      --amber:     #d29922;
      --text:      rgba(255,255,255,0.95);
      --muted:     rgba(255,255,255,0.7);
      --radius:    10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: linear-gradient(180deg, var(--bg-1), var(--bg-2));
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      min-height: 100vh;
      padding: 32px 16px;
    }

    .page-wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 28px;
    }
    .page-header-inner {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      transition: color .15s, border-color .15s;
    }
    .back-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.18); }

    .page-title {
      font-size: 22px;
      font-weight: 400;
      letter-spacing: -.4px;
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 18px;
    }
    .card-heading {
      font-size: 14px;
      font-weight: 400;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 16px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items: stretch;
    }
    .form-col {
      min-width: 0;
      display: flex;
    }
    .form-col .card { flex: 1; }
    .send-card {
      text-align: center;
    }
    .send-card .send-btn {
      width: 260px;
      max-width: 100%;
      margin: 0 auto;
      display: block;
    }

    /* ‚îÄ‚îÄ Banners ‚îÄ‚îÄ */
    .banner {
      border-radius: var(--radius);
      padding: 12px 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 18px;
      font-size: 14px;
    }
    .banner-success { background: rgba(63,185,80,.13); border: 1px solid rgba(63,185,80,.35); color: #3fb950; }
    .banner-error   { background: rgba(248,81,73,.13);  border: 1px solid rgba(248,81,73,.35);  color: #f85149; }
    .banner-icon    { font-size: 16px; flex-shrink: 0; line-height: 1.4; }

    /* ‚îÄ‚îÄ Form controls ‚îÄ‚îÄ */
    label {
      display: block;
      font-size: 14px;
      font-weight: 400;
      color: var(--muted);
      margin-bottom: 7px;
    }
    select, input[type="text"], input[type="email"], textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color .15s;
      margin-bottom: 18px;
    }
    select:focus, input:focus, textarea:focus {
      border-color: var(--accent);
    }
    textarea { resize: none; min-height: 130px; line-height: 1.55; }

    /* ‚îÄ‚îÄ Pending badge ‚îÄ‚îÄ */
    .pending-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 18px;
      font-size: 14px;
    }
    .pending-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px; height: 36px;
      border-radius: 8px;
      background: rgba(210,153,34,.15);
      border: 1px solid rgba(210,153,34,.35);
      color: #d29922;
      font-weight: 400;
      font-size: 18px;
    }
    .pending-count-badge.zero {
      background: rgba(255,255,255,.06);
      border-color: var(--border);
      color: var(--muted);
    }
    .pending-label { color: var(--muted); }
    .pending-label strong { color: var(--text); }

    /* ‚îÄ‚îÄ Channel selector ‚îÄ‚îÄ */
    .channel-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 18px;
    }
    .channel-opt { display: none; }
    .channel-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 14px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: border-color .15s, background .15s;
      font-size: 14px;
      color: var(--muted);
    }
    .channel-label span.icon { font-size: 22px; }
    .channel-opt:checked + .channel-label {
      border-color: var(--accent);
      background: rgba(79,142,247,.1);
      color: var(--text);
    }
    .channel-opt[value="sms"]:checked + .channel-label { border-color: #3fb950; background: rgba(63,185,80,.08); }

    .recipient-section { display: none; }
    .recipient-section.visible { display: block; }

    /* ‚îÄ‚îÄ SMS placeholder ‚îÄ‚îÄ */
    .sms-note {
      background: rgba(139,92,246,.1);
      border: 1px solid rgba(139,92,246,.3);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 14px;
      color: #a78bfa;
      margin-bottom: 18px;
    }

    /* ‚îÄ‚îÄ Submit button ‚îÄ‚îÄ */
    .send-btn {
      width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, #1d4ed8, #4f8ef7);
      border: none;
      border-radius: var(--radius);
      color: #fff;
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      letter-spacing: -.1px;
      transition: opacity .15s, filter .15s;
    }
    .send-btn:hover { filter: brightness(1.1); }
    .send-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* ‚îÄ‚îÄ No rads state ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 40px 0;
      color: var(--muted);
    }
    .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }

    /* ‚îÄ‚îÄ History table ‚îÄ‚îÄ */
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .history-table th,
    .history-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .history-table th {
      color: var(--muted);
      font-weight: 400;
    }
    .history-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .history-table tbody tr:hover { background: rgba(79,142,247,0.06); }
    .history-message {
      max-width: 360px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 960px) {
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="page-wrap">

  <!-- Header -->
  <div class="page-header">
    <div class="page-header-inner">
      <a href="/admin" class="back-btn">‚Üê Dashboard</a>
      <h1 class="page-title">Notify Radiologist</h1>
    </div>
  </div>

  <!-- Success banner -->
  {% if sent %}
  <div class="banner banner-success">
    <span class="banner-icon">‚úÖ</span>
    <span>Notification sent successfully to <strong>{{ selected_name }}</strong>.</span>
  </div>
  {% endif %}

  <!-- Error banners -->
  {% if error == "no_email" %}
  <div class="banner banner-error">
    <span class="banner-icon">‚ö†Ô∏è</span>
    <span>Please enter a valid email address for this radiologist.</span>
  </div>
  {% elif error == "smtp_not_configured" %}
  <div class="banner banner-error">
    <span class="banner-icon">‚ö†Ô∏è</span>
    <span>SMTP is not configured. Set the <strong>SMTP_HOST</strong>, <strong>SMTP_USER</strong>, and <strong>SMTP_PASS</strong> environment variables to enable email notifications.</span>
  </div>
  {% elif error == "send_failed" %}
  <div class="banner banner-error">
    <span class="banner-icon">‚ö†Ô∏è</span>
    <span>Failed to send email. Check SMTP credentials and server logs.</span>
  </div>
  {% elif error == "sms_not_configured" %}
  <div class="banner banner-error">
    <span class="banner-icon">‚ö†Ô∏è</span>
    <span>SMS notifications require Twilio integration (not yet configured).</span>
  </div>
  {% endif %}

  {% if radiologists %}

  <!-- JSON data for JS -->
  <script>
    const PENDING = {{ pending_counts | tojson }};
    const RAD_EMAILS = {{ rad_emails | tojson }};
  </script>

  <form method="post" action="/admin/notify-radiologist" id="notifyForm">

    <!-- Radiologist picker -->
    <div class="card">
      <div class="card-heading">Select Radiologist</div>
      <label for="radSelect">Radiologist</label>
      <select name="radiologist_name" id="radSelect" required>
        <option value="">‚Äî choose ‚Äî</option>
        {% for r in radiologists %}
        <option value="{{ r.name }}"
          {% if r.name == selected_name %}selected{% endif %}>
          {{ r.name }}
        </option>
        {% endfor %}
      </select>

      <!-- Pending info -->
      <div class="pending-info" id="pendingInfo" style="display:none;">
        <div class="pending-count-badge" id="pendingBadge">0</div>
        <div class="pending-label">
          case(s) currently <strong>pending / reopened</strong> for this radiologist
        </div>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-col">
        <!-- Channel selector -->
        <div class="card">
          <div class="card-heading">Notification Channel</div>
          <div class="channel-group">
            <div>
              <input type="radio" name="channel" id="ch-email" value="email" class="channel-opt" checked>
              <label for="ch-email" class="channel-label">
                <span class="icon">üìß</span>Email
              </label>
            </div>
            <div>
              <input type="radio" name="channel" id="ch-sms" value="sms" class="channel-opt">
              <label for="ch-sms" class="channel-label">
                <span class="icon">üí¨</span>Text / SMS
              </label>
            </div>
          </div>

          <!-- Email recipient -->
          <div class="recipient-section visible" id="emailSection">
            {% if not smtp_configured %}
            <div class="banner banner-error" style="margin-bottom:14px;">
              <span class="banner-icon">‚ö†Ô∏è</span>
              <span>SMTP not configured ‚Äî emails cannot be sent until <strong>SMTP_HOST</strong> env var is set.</span>
            </div>
            {% endif %}
            <label for="recipientEmail">Recipient Email</label>
            <input type="email" name="recipient" id="recipientEmail"
                   placeholder="radiologist@hospital.com"
                   value="{{ (rad_emails.get(selected_name, '')) if selected_name else '' }}">
          </div>

          <!-- SMS placeholder -->
          <div class="recipient-section" id="smsSection">
            <div class="sms-note">
              SMS notifications are not yet active. Twilio integration can be added ‚Äî contact your system administrator.
            </div>
          </div>
        </div>
      </div>

      <div class="form-col">
        <!-- Message -->
        <div class="card">
          <div class="card-heading">Message</div>
          <label for="messageBox">Notification Message</label>
          <textarea name="message" id="messageBox" required>{% if selected_name %}Hi {{ selected_name }},

You currently have {{ pending_counts.get(selected_name, 0) }} case(s) awaiting your review in the Vetting Suite.

Please log in at your earliest convenience to action any outstanding items.

Thanks,
Vetting Suite Admin{% else %}Select a radiologist above to generate a message.{% endif %}</textarea>
        </div>
      </div>
    </div>

    <div class="card send-card">
      <div class="card-heading">Send Notification</div>
      <button type="submit" class="send-btn" id="sendBtn">Send Notification</button>
    </div>
  </form>

  <div class="card">
    <div class="card-heading">Notification History - Past 7 Days</div>
    {% if notify_history and notify_history|length > 0 %}
      <table class="history-table">
        <thead>
          <tr>
            <th>Sent</th>
            <th>Radiologist</th>
            <th>Channel</th>
            <th>Recipient</th>
            <th>Sent By</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
          {% for h in notify_history %}
            <tr>
              <td>{{ h.created_display }}</td>
              <td>{{ h.radiologist_name }}</td>
              <td>{{ h.channel|upper }}</td>
              <td>{{ h.recipient or "‚Äî" }}</td>
              <td>{{ h.created_by or "‚Äî" }}</td>
              <td class="history-message">{{ (h.message or "")|replace('\n',' ') }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty-state">
        <p>No notifications sent in the past 7 days.</p>
      </div>
    {% endif %}
  </div>

  {% else %}
  <div class="card">
    <div class="empty-state">
      <div class="emoji">üë•</div>
      <p>No radiologists are registered in this organisation.</p>
    </div>
  </div>
  {% endif %}

</div>

<script>
(function () {
  const radSelect   = document.getElementById('radSelect');
  const pendingInfo = document.getElementById('pendingInfo');
  const pendBadge   = document.getElementById('pendingBadge');
  const emailInput  = document.getElementById('recipientEmail');
  const msgBox      = document.getElementById('messageBox');
  const emailSect   = document.getElementById('emailSection');
  const smsSect     = document.getElementById('smsSection');
  const sendBtn     = document.getElementById('sendBtn');
  const chEmail     = document.getElementById('ch-email');
  const chSms       = document.getElementById('ch-sms');

  function updateRadiologist() {
    const name = radSelect ? radSelect.value : '';
    if (!name) {
      if (pendingInfo) pendingInfo.style.display = 'none';
      return;
    }

    const count = (typeof PENDING !== 'undefined' && PENDING[name] !== undefined)
      ? PENDING[name] : 0;

    if (pendingInfo) pendingInfo.style.display = 'flex';
    if (pendBadge) {
      pendBadge.textContent = count;
      pendBadge.className = 'pending-count-badge' + (count === 0 ? ' zero' : '');
    }

    // Auto-fill email
    if (emailInput && typeof RAD_EMAILS !== 'undefined') {
      emailInput.value = RAD_EMAILS[name] || '';
    }

    // Regenerate message
    if (msgBox) {
      const existing = msgBox.value;
      const hasCustom = existing && existing.indexOf('Select a radiologist') === -1;
      if (!hasCustom || !existing.trim()) {
        msgBox.value =
          `Hi ${name},\n\nYou currently have ${count} case(s) awaiting your review in the Vetting Suite.\n\nPlease log in at your earliest convenience to action any outstanding items.\n\nThanks,\nVetting Suite Admin`;
      }
    }
  }

  function updateChannel() {
    const isSms = chSms && chSms.checked;
    if (emailSect) emailSect.classList.toggle('visible', !isSms);
    if (smsSect)   smsSect.classList.toggle('visible',  isSms);
  }

  if (radSelect) radSelect.addEventListener('change', updateRadiologist);
  if (chEmail)   chEmail.addEventListener('change', updateChannel);
  if (chSms)     chSms.addEventListener('change', updateChannel);

  // Run on page load
  updateRadiologist();
  updateChannel();
})();
</script>
</body>
</html>
