<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vetting App | Admin</title>
  <link rel="stylesheet" href="/static/css/site.css">
</head>
<body>
  <div class="topbar">
    <div>
      <h1 style="margin:0;">Admin dashboard</h1>
      <p style="margin:6px 0 0; color:#555;">Vetting cases.</p>
      {% if current_user %}
        <div class="small">Logged in as: {{ current_user["username"] }} ({{ current_user["role"] }})</div>
      {% endif %}
    </div>

    <div class="actions">
      <a class="btn secondary" href="/settings">Settings</a>
      <a class="btn" href="/submit">Submit new case</a>
      <a class="btn secondary" href="/logout">Logout</a>
    </div>
  </div>

  <!-- Tabs + CSV -->
  <div class="tabs">
    <a class="tablink {% if tab == 'all' %}active{% endif %}"
       href="/admin?tab=all&radiologist={{ selected_radiologist }}&q={{ q }}">All</a>

    <a class="tablink {% if tab == 'pending' %}active{% endif %}"
       href="/admin?tab=pending&radiologist={{ selected_radiologist }}&q={{ q }}">Pending</a>

    <a class="tablink {% if tab == 'vetted' %}active{% endif %}"
       href="/admin?tab=vetted&radiologist={{ selected_radiologist }}&q={{ q }}">Vetted</a>

    <span style="margin-left:auto;">
      <a href="/admin.csv?tab={{ tab }}&radiologist={{ selected_radiologist }}&q={{ q }}">Download CSV</a>
    </span>
  </div>

  <!-- Filters (keeps tab) -->
  <form method="get" action="/admin" class="filters">
    <input type="hidden" name="tab" value="{{ tab }}">

    <div>
      <label>Radiologist</label>
      <select name="radiologist">
        <option value="" {% if selected_radiologist == "" %}selected{% endif %}>All</option>
        {% for r in radiologists %}
          <option value="{{ r }}" {% if selected_radiologist == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Search (Patient ID or Study)</label>
      <input name="q" value="{{ q }}" placeholder="e.g. 123456 or CT Head">
    </div>

    <div style="align-self:flex-end;">
      <button type="submit" class="btn">Apply</button>
      <a href="/admin?tab={{ tab }}" style="margin-left:8px;">Reset</a>
    </div>
  </form>

  {% if cases|length == 0 %}
    <p>No cases found.</p>
  {% else %}
    <table>
      <thead>
        <tr>
          <th>Status</th>
          <th>Created</th>
          <th>TAT</th>
          <th>Patient</th>
          <th>Study</th>
          <th>Radiologist</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cases %}
          <tr>
            <td><span class="pill" data-status="{{ c['status']|lower }}">{{ c["status"] }}</span></td>

            <td>
              {% if c["created_display"] is defined %}
                {{ c["created_display"] }}
              {% else %}
                {{ c["created_at"] }}
              {% endif %}
            </td>

            <td>
              <span class="tat"
                    data-created="{% if c['created_iso'] is defined %}{{ c['created_iso'] }}{% endif %}"
                    data-status="{{ c['status'] }}">
                {% if c["tat_display"] is defined %}
                  {{ c["tat_display"] }}
                {% elif c["age_display"] is defined %}
                  {{ c["age_display"] }}
                {% endif %}
              </span>
            </td>

            <td>{{ c["patient_id"] }}</td>
            <td>{{ c["study_description"] }}</td>
            <td>{{ c["radiologist"] }}</td>
            <td class="row-actions">
                <a href="/admin/case/{{ c['id'] }}">Open</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    function formatTat(seconds) {
      if (seconds < 60) return "<1m";
      const minutesTotal = Math.floor(seconds / 60);
      const hoursTotal = Math.floor(minutesTotal / 60);
      const days = Math.floor(hoursTotal / 24);
      const minutes = minutesTotal % 60;
      const hours = hoursTotal % 24;

      if (days > 0) return `${days}d ${String(hours).padStart(2,"0")}h ${String(minutes).padStart(2,"0")}m`;
      if (hoursTotal > 0) return `${String(hoursTotal).padStart(2,"0")}h ${String(minutes).padStart(2,"0")}m`;
      return `${minutesTotal}m`;
    }

    function isPending(status) {
      if (!status) return false;
      const s = String(status).toLowerCase();
      return s === "pending" || s === "p e n d i n g".replace(/ /g,"") || s === "pending";
    }

    function updateTats() {
      const now = new Date();
      document.querySelectorAll(".tat").forEach(el => {
        const iso = el.getAttribute("data-created");
        const status = el.getAttribute("data-status");
        if (!iso) return;

        // Stop updating once vetted
        const s = String(status || "").toLowerCase();
        if (s === "vetted" || s === "vetted".toLowerCase() || s === "vetted".toUpperCase().toLowerCase()) {
          return;
        }
        if (s === "vetted" || s === "vetted") return; // defensive
        if (s === "vetted") return;

        // If your DB uses PENDING/VETTED uppercase, this still works:
        if (s === "vetted") return;
        if (s === "vetted") return;

        // Only update while pending (covers pending/PENDING)
        if (s !== "pending") return;

        const created = new Date(iso);
        const diffSeconds = Math.max(0, Math.floor((now - created) / 1000));
        el.textContent = formatTat(diffSeconds);
      });
    }

    updateTats();
    setInterval(updateTats, 30000);
  </script>
</body>
</html>
