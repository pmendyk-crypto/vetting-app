<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vetting App | Admin</title>
  <link rel="stylesheet" href="/static/css/site.css">
  <style>
    .brand-logo {
      width: 52px;
      height: 52px;
      border-radius: 8px;
      object-fit: cover;
      flex: 0 0 auto;
    }

    .tab-buttons { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.14); border-radius: 6px; color: rgba(255,255,255,0.85); cursor: pointer; font-weight: 400; font-size: 14px; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .tab-btn:hover { background: rgba(255,255,255,0.12); }
    .tab-count { display: inline-block; border-radius: 999px; font-size: 11px; font-weight: 400; padding: 2px 8px; min-width: 22px; text-align: center; }
    /* All — blue */
    .tab-btn-all .tab-count { background: rgba(31,111,235,0.25); color: #7eb8ff; border: 1px solid rgba(31,111,235,0.4); }
    .tab-btn-all.active { background: rgba(31,111,235,0.2); border-color: #1f6feb; color: #fff; }
    .tab-btn-all.active .tab-count { background: #1f6feb; color: #fff; border-color: #1f6feb; }
    /* Pending — amber */
    .tab-btn-pending .tab-count { background: rgba(245,158,11,0.2); color: #fbbf24; border: 1px solid rgba(245,158,11,0.4); }
    .tab-btn-pending.active { background: rgba(245,158,11,0.15); border-color: #f59e0b; color: #fbbf24; }
    .tab-btn-pending.active .tab-count { background: #f59e0b; color: #1a0e00; border-color: #f59e0b; }
    /* Vetted — green */
    .tab-btn-vetted .tab-count { background: rgba(34,197,94,0.2); color: #4ade80; border: 1px solid rgba(34,197,94,0.4); }
    .tab-btn-vetted.active { background: rgba(34,197,94,0.15); border-color: #22c55e; color: #4ade80; }
    .tab-btn-vetted.active .tab-count { background: #22c55e; color: #052e16; border-color: #22c55e; }
    /* Rejected — red */
    .tab-btn-rejected .tab-count { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
    .tab-btn-rejected.active { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #fca5a5; }
    .tab-btn-rejected.active .tab-count { background: #ef4444; color: #fff; border-color: #ef4444; }
    .filters-section { background: var(--card-bg); border: 1px solid var(--card-border); padding: 16px; border-radius: 8px; margin-bottom: 16px; }
    .filters-content { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; }
    .filter-group label { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    .filter-group input, .filter-group select { padding: 8px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.3); color: white; font-size: 14px; }
    /* Main dashboard table styling */
    table { table-layout: fixed; width: 100%; border-collapse: collapse; margin-top: 4px; }
    table thead th { 
      text-align: left; 
      padding: 12px 12px; 
      font-size: 11px; 
      font-weight: 500; 
      text-transform: uppercase; 
      letter-spacing: 0.6px; 
      color: rgba(255,255,255,0.5); 
      background: rgba(255,255,255,0.03); 
      border-bottom: 1px solid rgba(255,255,255,0.12);
      cursor: pointer; 
      user-select: none; 
      position: relative;
    }
    table th:hover { background: rgba(255,255,255,0.08); }
    table th.sortable::after { content: " ↕"; opacity: 0.5; font-size: 11px; }
    table th.sort-asc::after { content: " ↑"; opacity: 1; }
    table th.sort-desc::after { content: " ↓"; opacity: 1; }
    
    /* Column widths */
    #col-status { width: 90px; }
    #col-created { width: 130px; }
    #col-tat { width: 80px; }
    #col-fname { width: 110px; }
    #col-sname { width: 110px; }
    #col-pid { width: 120px; }
    #col-dob { width: 100px; }
    #col-inst { width: 150px; }
    #col-study { width: auto; min-width: 180px; }
    #col-rad { width: 180px; }
    #col-actions { width: 200px; }
    
    table tbody td { 
      padding: 12px 12px; 
      font-size: 13px; 
      vertical-align: middle; 
      color: rgba(255,255,255,0.82);
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    table tbody td:nth-child(2),
    table tbody td:nth-child(3) { 
      font-size: 12px; 
      color: rgba(255,255,255,0.5); 
      font-family: 'Courier New', monospace; 
    }
    table tbody td.row-actions { 
      overflow: visible; 
      white-space: nowrap; 
    }
    table tbody tr { transition: background 0.15s; }
    table tbody tr:hover { background: rgba(255,255,255,0.04); }
    
    /* Improved pill styling */
    .pill { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 6px; 
      font-size: 11px; 
      font-weight: 500; 
      letter-spacing: 0.3px; 
      text-transform: uppercase;
    }
    .pill[data-status="pending"] { background: rgba(245,158,11,0.18); color: #fbbf24; border: 1px solid rgba(245,158,11,0.35); }
    .pill[data-status="vetted"] { background: rgba(34,197,94,0.18); color: #4ade80; border: 1px solid rgba(34,197,94,0.35); }
    .pill[data-status="rejected"] { background: rgba(239,68,68,0.18); color: #fca5a5; border: 1px solid rgba(239,68,68,0.35); }
    /* Action buttons in table */
    .row-actions a { 
      color: #4ea1ff; 
      text-decoration: none; 
      margin-right: 12px; 
      font-size: 13px;
      font-weight: 400;
    }
    .row-actions a:hover { 
      text-decoration: underline; 
      color: #7eb8ff;
    }
    
    /* Radiologist assignment form */
    .assign-form { 
      display: flex; 
      gap: 6px; 
      align-items: center; 
    }
    .assign-form select {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.3);
      color: rgba(255,255,255,0.85);
      max-width: 140px;
    }
    .assign-save-btn {
      background: transparent;
      border: none;
      color: #4ea1ff;
      font-size: 12px;
      font-weight: 400;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .assign-save-btn:hover {
      color: #7eb8ff;
    }
    /* resize handle */
    .col-resize-handle {
        position: absolute;
        right: 0; top: 20%; bottom: 20%;
        width: 5px;
        cursor: col-resize;
        z-index: 10;
        border-radius: 3px;
        background: rgba(180,190,210,0.45);
        transition: background 0.15s, width 0.1s;
    }
    .col-resize-handle::before {
        content: '';
        position: absolute;
        left: 50%; top: 25%; bottom: 25%;
        width: 2px;
        transform: translateX(-50%);
        border-left: 1px dotted rgba(120,140,175,0.7);
        border-right: 1px dotted rgba(120,140,175,0.7);
    }
    .col-resize-handle:hover,
    .col-resize-handle.dragging {
        background: rgba(31,111,235,0.7);
        width: 6px;
    }
    .col-resize-handle:hover::before,
    .col-resize-handle.dragging::before {
        border-color: transparent;
    }
    @media (max-width: 1200px) {
      .filters-content { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 700px) {
      .filters-content { grid-template-columns: 1fr; }
      .tab-buttons { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="session-expiry-warning">⚠️ Your session will expire in 5 minutes due to inactivity. <a href="/login" style="color:#fde68a;font-weight:400;">Sign in again</a> to continue.</div>
  <div class="topbar">
    <div style="display: flex; align-items: center; gap: 16px;">
      <img class="brand-logo" src="/static/images/logo-light.png" alt="Lumos Lab"
        onerror="this.style.display='none';">
      <div>
        <h1 style="margin:0; font-weight:400;">{{ org_name|replace('Admin Dashboard', 'Dashboard') if org_name else 'Dashboard' }}</h1>
      </div>
    </div>

    <div class="actions" style="flex-direction: column; align-items: flex-end; gap: 14px;">
      {% if current_user %}
        <a href="/account" style="display:flex; align-items:center; gap:12px; text-decoration:none; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:10px 16px; width:100%; box-sizing:border-box; margin-bottom:6px;">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#1f6feb,#7c3aed);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:400;color:#fff;flex-shrink:0;">
            {{ current_user["username"][0] | upper }}
          </div>
          <div style="line-height:1.4;">
            <div style="font-size:14px;font-weight:400;color:rgba(255,255,255,0.9);">{{ current_user["username"] }}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.45);text-transform:capitalize;">{{ current_user["role"] }}</div>
          </div>
        </a>
      {% endif %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; width:100%;">
        <a class="btn secondary" href="/admin.csv?tab={{ tab }}" style="padding:8px 16px; font-size:14px;">⬇ Download STAT</a>
        <a class="btn secondary" href="/settings" style="padding:8px 16px; font-size:14px;">Settings</a>
        <a class="btn secondary" href="/logout" style="padding:8px 16px; font-size:14px;">Logout</a>
      </div>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="tab-buttons">
    <a href="/admin?tab=all&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}" class="tab-btn tab-btn-all {% if tab == 'all' %}active{% endif %}">All <span class="tab-count">{{ total_count }}</span></a>
    <a href="/admin?tab=pending&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}" class="tab-btn tab-btn-pending {% if tab == 'pending' %}active{% endif %}">Pending <span class="tab-count">{{ pending_count }}</span></a>
    <a href="/admin?tab=vetted&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}" class="tab-btn tab-btn-vetted {% if tab == 'vetted' %}active{% endif %}">Vetted <span class="tab-count">{{ vetted_count }}</span></a>
    <a href="/admin?tab=rejected&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}" class="tab-btn tab-btn-rejected {% if tab == 'rejected' %}active{% endif %}">Rejected <span class="tab-count">{{ rejected_count }}</span></a>

  </div>

  <!-- Filters -->
  <div class="filters-section">
    <form method="get" action="/admin" style="display: contents;">
      <input type="hidden" name="tab" value="{{ tab }}">
      <input type="hidden" name="sort_by" value="{{ sort_by }}">
      <input type="hidden" name="sort_dir" value="{{ sort_dir }}">

      <div class="filters-content">
        <div class="filter-group">
          <label>Institution</label>
          <select name="institution" onchange="this.form.submit()">
            <option value="">All Institutions</option>
            {% for inst in institutions %}
              <option value="{{ inst.id }}" {% if selected_institution == inst.id|string %}selected{% endif %}>{{ inst.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label>Radiologist</label>
          <select name="radiologist" onchange="this.form.submit()">
            <option value="">All Radiologists</option>
            {% for r in radiologists %}
              <option value="{{ r }}" {% if selected_radiologist == r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label>Search (Name, ID, Study)</label>
          <input name="q" value="{{ q }}" placeholder="Search...">
        </div>

        <div style="display: flex; gap: 8px; align-items: flex-end; justify-content: flex-end;">
          <button type="submit" class="btn" style="margin:0; padding:8px 16px; font-size:14px; white-space:nowrap;">Apply</button>
          <a href="/admin?tab={{ tab }}" class="btn secondary" style="margin:0; padding:8px 16px; font-size:14px; white-space:nowrap; text-decoration:none;">Reset</a>
          <a href="/submit" class="btn" style="margin:0; padding:8px 16px; font-size:14px; white-space:nowrap; text-decoration:none;">Submit New Case</a>
          <a href="/admin/notify-radiologist" class="btn" style="margin:0; padding:8px 16px; font-size:14px; white-space:nowrap; text-decoration:none;">Notify</a>
        </div>
      </div>
    </form>
  </div>

  {% if cases|length == 0 %}
    <p style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px;">No cases found.</p>
  {% else %}
    <table>
      <colgroup>
        <col id="col-status">
        <col id="col-created">
        <col id="col-tat">
        <col id="col-fname">
        <col id="col-sname">
        <col id="col-pid">
        <col id="col-dob">
        <col id="col-inst">
        <col id="col-study">
        <col id="col-rad">
        <col id="col-actions">
      </colgroup>
      <thead>
        <tr>
          <th class="sortable" onclick="updateSort('status')">Status</th>
          <th class="sortable" onclick="updateSort('created_at')">Created</th>
          <th class="sortable" onclick="updateSort('tat')">TAT</th>
          <th class="sortable" onclick="updateSort('patient_first_name')">First Name</th>
          <th class="sortable" onclick="updateSort('patient_surname')">Surname</th>
          <th class="sortable" onclick="updateSort('patient_referral_id')">Patient ID</th>
          <th>Patient DOB</th>
          <th class="sortable" onclick="updateSort('institution_id')">Institution</th>
          <th class="sortable" onclick="updateSort('study_description')">Study Description</th>
          <th class="sortable" onclick="updateSort('radiologist')">Radiologist</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cases %}
          <tr class="case-row" data-open-url="/admin/case/{{ c['id'] }}">
            <td><span class="pill" data-status="{{ c['status']|lower }}">{{ c["status"]|capitalize }}</span></td>
            <td>{{ c["created_display"] }}</td>
            <td>{{ c["tat_display"] }}</td>
            <td>{{ c["patient_first_name"] }}</td>
            <td>{{ c["patient_surname"] }}</td>
            <td>{{ c["patient_referral_id"] }}</td>
            <td>{{ c["patient_dob"] or "—" }}</td>
            <td>{{ c["institution_name"] or "—" }}</td>
            <td>{{ c["study_description"] }}</td>
            <td>
              <form method="post" action="/admin/case/{{ c['id'] }}/assign-radiologist" class="assign-form">
                <select name="radiologist">
                  <option value="">Unassigned</option>
                  {% for r in radiologists %}
                    <option value="{{ r }}" {% if c["radiologist"] == r %}selected{% endif %}>{{ r }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="assign-save-btn">Save</button>
              </form>
            </td>
            <td class="row-actions">
              <a href="/admin/case/{{ c['id'] }}">Open</a>
              <a href="/admin/case/{{ c['id'] }}/edit">Edit</a>
              <a href="/case/{{ c['id'] }}/pdf" target="_blank">Download</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    function initializeCaseRowClicks() {
      document.querySelectorAll('tbody tr.case-row[data-open-url]').forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', (event) => {
          if (event.target.closest('a, button, input, select, textarea, label, form')) {
            return;
          }
          const openUrl = row.getAttribute('data-open-url');
          if (openUrl) {
            window.location.href = openUrl;
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCaseRowClicks);
    } else {
      initializeCaseRowClicks();
    }

    function updateSort(column) {
      const currentSort = new URLSearchParams(window.location.search).get('sort_by');
      const currentDir = new URLSearchParams(window.location.search).get('sort_dir') || 'desc';
      const newDir = (currentSort === column && currentDir === 'desc') ? 'asc' : 'desc';
      const tab = new URLSearchParams(window.location.search).get('tab') || 'all';
      const institution = new URLSearchParams(window.location.search).get('institution') || '';
      const radiologist = new URLSearchParams(window.location.search).get('radiologist') || '';
      const q = new URLSearchParams(window.location.search).get('q') || '';
      
      let url = `/admin?tab=${tab}&sort_by=${column}&sort_dir=${newDir}`;
      if (institution) url += `&institution=${institution}`;
      if (radiologist) url += `&radiologist=${radiologist}`;
      if (q) url += `&q=${q}`;
      
      window.location.href = url;
    }

    // Mark active sort header
    const sortBy = new URLSearchParams(window.location.search).get('sort_by') || 'created_at';
    const sortDir = new URLSearchParams(window.location.search).get('sort_dir') || 'desc';
    document.querySelectorAll('th.sortable').forEach(th => {
      const col = th.textContent.toLowerCase().trim();
      const mapToSort = {
        'created': 'created_at',
        'tat': 'tat',
        'first name': 'patient_first_name',
        'surname': 'patient_surname',
        'patient id': 'patient_referral_id',
        'institution': 'institution_id',
        'status': 'status',
        'study': 'study_description',
        'radiologist': 'radiologist'
      };
      if (mapToSort[col] === sortBy) {
        th.classList.add(`sort-${sortDir}`);
      }
    });
  </script>

  <script>
    // ── Column resize with localStorage persistence ──────────────────
    const COL_DEFAULTS = {
      'col-status':  72,
      'col-created': 100,
      'col-tat':     62,
      'col-fname':   76,
      'col-sname':   76,
      'col-pid':     88,
      'col-dob':     88,
      'col-inst':    170,
      'col-study':   122,
      'col-rad':     220,
      'col-actions': 160
    };
    const LS_KEY = 'adminDashColWidths';

    function loadWidths() {
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; }
    }
    function saveWidths(map) {
      localStorage.setItem(LS_KEY, JSON.stringify(map));
    }
    function applyWidths() {
      const saved = loadWidths();
      Object.keys(COL_DEFAULTS).forEach(id => {
        const col = document.getElementById(id);
        if (col) col.style.width = (saved[id] || COL_DEFAULTS[id]) + 'px';
      });
    }

    function initResizeHandles() {
      const headers = document.querySelectorAll('table thead th');
      const colIds = Object.keys(COL_DEFAULTS);
      headers.forEach((th, i) => {
        if (i >= colIds.length - 1) return; // no handle on last column
        const handle = document.createElement('div');
        handle.className = 'col-resize-handle';
        handle.title = 'Drag to resize';
        handle.addEventListener('mousedown', function(e) {
          e.preventDefault();
          e.stopPropagation();
          handle.classList.add('dragging');
          const startX = e.pageX;
          const colEl = document.getElementById(colIds[i]);
          const startW = colEl ? colEl.offsetWidth : COL_DEFAULTS[colIds[i]];
          function onMove(e) {
            const newW = Math.max(40, startW + (e.pageX - startX));
            if (colEl) colEl.style.width = newW + 'px';
          }
          function onUp() {
            handle.classList.remove('dragging');
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            // Persist all current widths
            const map = {};
            colIds.forEach(id => {
              const c = document.getElementById(id);
              if (c) map[id] = c.offsetWidth;
            });
            saveWidths(map);
          }
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        });
        th.appendChild(handle);
      });
    }

    // Reset button — double-click any header to reset all widths
    document.addEventListener('dblclick', function(e) {
      if (e.target.closest('table thead th') && !e.target.classList.contains('col-resize-handle')) {
        localStorage.removeItem(LS_KEY);
        Object.keys(COL_DEFAULTS).forEach(id => {
          const c = document.getElementById(id);
          if (c) c.style.width = COL_DEFAULTS[id] + 'px';
        });
      }
    });

    applyWidths();
    initResizeHandles();
  </script>
  <script src="/static/js/session.js"></script>
</body>
</html>
